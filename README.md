

**OpenSSH <= 6.6 SFTP misconfiguration exploit for 32/64bit Linux**

OpenSSH lets you grant SFTP access to users without allowing full command
execution using "ForceCommand internal-sftp". However, if you misconfigure
the server and don't use ChrootDirectory, the user will be able to access
all parts of the filesystem that he has access to - including procfs. On
modern Linux kernels (>=2.6.39, I think), /proc/self/maps reveals the
memory layout and /proc/self/mem lets you write to arbitrary memory
positions. Combine those and you get easy RCE.

The linux version of OpenSSH 6.7 contains a mitigation, see the release notes:

 * sftp-server(8): On platforms that support it, use prctl() to
   prevent sftp-server from accessing /proc/self/{mem,maps}

PoC for 64bit Linux in C and a python script is available for exploitation validation

In simple word , this exlpoit can be used to access the system using ssh while having only sftp allowed through ssh.

The misconfiguration of sftp in ssh configuration file "/etc/ssh/sshd_config" looks like :

    #sftp configuration 
    Match User $USER 
    ForceCommand internal-sftp 
    PasswordAuthentication yes 
    PermitTunnel no 
    AllowAgentForwarding no 
    AllowTcpForwarding no 
    X11Forwarding no 

Here in this scenario "$USER" is the user account u want to log in.

Also , in configuration it is clearly visible that following services are disabled for the user account

 - Tunneling through ssh
 - Forwarding through ssh like TCP , x11 etc.

While on the other hand , this vulnerability or exploit can be used to regain lost  access to "**jailed remote virtual machine**" , that what i done in my case .

Q.1  What i referring to "**jailed remote virtual machine**" ?
Ans.  As for any cloud VM , the only way to manage it is **ssh** . But if u have a only single user along with the **root** and u use the same **$USER** for setup **sftp** , following above configuration in ssh  config , u got locked urself in the **cloud VM** and u will not able to ssh new connection to **VM** after applying configuration and restarting ssh daemon.

The only fallback way to access is **root** login and is only possible if u enabled it earlier in ssh configuration with **PasswordAuthentication** also enabled.  
  
The original discovery by Jann Horn: http://seclists.org/fulldisclosure/2014/Oct/35

https://www.secforce.com/blog/2018/03/openssh_exploit_32_and_64_bit/
